import { Directive, Input, Output, HostListener, Inject, EventEmitter } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { EMPTY, Observable, Subject } from 'rxjs';
import { takeUntil, tap } from 'rxjs/operators';
import { SharerMethod } from './share.models';
import { getValidUrl } from './utils';
import * as i0 from "@angular/core";
import * as i1 from "@angular/platform-browser";
import * as i2 from "@angular/cdk/platform";
import * as i3 from "@angular/cdk/clipboard";
import * as i4 from "./share.service";
export class ShareDirective {
    constructor(_el, _meta, _platform, _clipboard, _share, _cd, _document) {
        this._meta = _meta;
        this._platform = _platform;
        this._clipboard = _clipboard;
        this._share = _share;
        this._cd = _cd;
        this._document = _document;
        /** Stream that emits when button is destroyed */
        this._destroyed = new Subject();
        /** Stream that emit when share button need to be updated */
        this._updater = new Subject();
        /** Set meta tags from document head, useful when SEO is supported */
        this.autoSetMeta = this._share.config.autoSetMeta;
        /** Sharing link */
        this.url = this._share.config.url;
        /** Sets the title parameter */
        this.title = this._share.config.title;
        /** Sets the description parameter */
        this.description = this._share.config.description;
        /** Sets the image parameter for sharing on Pinterest */
        this.image = this._share.config.image;
        /** Sets the tags parameter for sharing on Twitter and Tumblr */
        this.tags = this._share.config.tags;
        /** Stream that emits when share dialog is opened */
        this.opened = new EventEmitter();
        /** Stream that emits when share dialog is closed */
        this.closed = new EventEmitter();
        this._el = _el.nativeElement;
    }
    /**
     * Share the link
     */
    share() {
        // Avoid SSR error
        if (this._platform.isBrowser && this.shareButton) {
            // Prepare sharer url params
            const params = this.autoSetMeta ? this.getParamsFromMetaTags() : this.getParamsFromInputs();
            // Prepare share button click
            const click = this.shareButton.share ? this.open(params) : this.shareButton.func({
                params,
                data: this.shareButton.data,
                clipboard: this._clipboard,
                updater: this._updater
            });
            click.pipe(takeUntil(this._destroyed)).subscribe();
        }
        else {
            console.warn(`${this.text} button is not compatible on this Platform`);
        }
    }
    ngOnInit() {
        // This stream is mainly used to update the copy button text and icon when it is being clicked
        this._updater.pipe(tap((data) => {
            this.icon = data.icon;
            this.text = data.text;
            this._el.style.pointerEvents = data.disabled ? 'none' : 'auto';
            this._cd.markForCheck();
        }), takeUntil(this._destroyed)).subscribe();
    }
    ngOnChanges(changes) {
        // Avoid SSR error
        if (this._platform.isBrowser) {
            // Create share button
            if (this._shareButtonChanged(changes.shareButtonName)) {
                this._createShareButton();
            }
            // Prepare share url
            if (this._urlChanged(changes.url)) {
                this.url = getValidUrl(this.autoSetMeta
                    ? this.url || this._getMetaTagContent('og:url')
                    : this.url, this._document.defaultView.location.href);
            }
        }
    }
    ngOnDestroy() {
        this._destroyed.next();
        this._destroyed.complete();
    }
    _createShareButton() {
        const button = this._share.config.prop[this.shareButtonName];
        if (button) {
            // Set share button properties
            this.shareButton = button;
            // Remove previous button class
            this._el.classList.remove(`sb-${this._buttonClass}`);
            // Add new button class
            this._el.classList.add(`sb-${this.shareButtonName}`);
            // Set button css color variable
            this._el.style.setProperty('--button-color', this.shareButton.color);
            // Keep a copy of the class for future replacement
            this._buttonClass = this.shareButtonName;
            this.color = this.shareButton.color;
            this.text = this.shareButton.text;
            this.icon = this.shareButton.icon;
            // Set aria-label attribute
            this._el.setAttribute('aria-label', button.ariaLabel);
        }
        else {
            console.error(`[ShareButtons]: The share button '${this.shareButtonName}' does not exist!`);
        }
    }
    /**
     * Get meta tag content
     */
    _getMetaTagContent(key) {
        const metaUsingProperty = this._meta.getTag(`property="${key}"`);
        if (metaUsingProperty) {
            return metaUsingProperty.getAttribute('content');
        }
        const metaUsingName = this._meta.getTag(`name="${key}"`);
        if (metaUsingName) {
            return metaUsingName.getAttribute('content');
        }
    }
    _shareButtonChanged(change) {
        return change && (change.firstChange || change.previousValue !== change.currentValue);
    }
    _urlChanged(change) {
        return !this.url || (change && change.previousValue !== change.currentValue);
    }
    /**
     * Get share params from meta tags first and fallback to user inputs
     */
    getParamsFromMetaTags() {
        return {
            url: this.url,
            title: this.title || this._getMetaTagContent('og:title'),
            description: this.description || this._getMetaTagContent('og:description'),
            image: this.image || this._getMetaTagContent('og:image'),
            via: this._share.config.twitterAccount,
            tags: this.tags
        };
    }
    /**
     * Get share params from user inputs
     */
    getParamsFromInputs() {
        return {
            url: this.url,
            title: this.title,
            description: this.description,
            image: this.image,
            tags: this.tags,
            via: this._share.config.twitterAccount,
        };
    }
    open(params) {
        // Set sharer link based on user's device
        let sharerLink;
        if (this._platform.IOS && this.shareButton.share.ios) {
            sharerLink = this.shareButton.share.ios;
        }
        else if (this._platform.ANDROID && this.shareButton.share.android) {
            sharerLink = this.shareButton.share.android;
        }
        else {
            sharerLink = this.shareButton.share.desktop;
        }
        if (sharerLink) {
            // Set sharer link params
            this._finalUrl = sharerLink + this._serializeParams(params);
            // Log the sharer link in debug mode
            if (this._share.config.debug) {
                console.log('[DEBUG SHARE BUTTON]: ', this._finalUrl);
            }
            // Open the share window
            // There are two methods available for opening the share window:
            // 1. Using a real anchor
            // 2. Using window.open
            const sharerMethod = this.shareButton.method || this._share.config.sharerMethod;
            const sharerTarget = this.shareButton.target || this._share.config.sharerTarget;
            switch (sharerMethod) {
                case SharerMethod.Anchor:
                    const linkElement = this._document.createElement('a');
                    // Make it open in a new tab/window (depends on user's browser configuration)
                    linkElement.setAttribute('target', sharerTarget);
                    // Prevent security vulnerability https://medium.com/@jitbit/target-blank-the-most-underestimated-vulnerability-ever-96e328301f4c
                    linkElement.setAttribute('rel', 'noopener noreferrer');
                    linkElement.href = this._finalUrl;
                    linkElement.click();
                    linkElement.remove();
                    break;
                case SharerMethod.Window:
                    // Open link using Window object
                    const openWindow = this._share.config.windowObj[this._share.config.windowFuncName];
                    const popUpWindow = openWindow(this._finalUrl, sharerTarget, this._share.windowSize);
                    // Prevent security vulnerability https://medium.com/@jitbit/target-blank-the-most-underestimated-vulnerability-ever-96e328301f4c
                    this._share.config.windowObj.opener = null;
                    // Resolve when share dialog is closed
                    if (popUpWindow) {
                        return new Observable((sub) => {
                            const pollTimer = this._document.defaultView.setInterval(() => {
                                if (popUpWindow.closed) {
                                    this._document.defaultView.clearInterval(pollTimer);
                                    // Emit when share windows is closed
                                    this.closed.emit(this.shareButtonName);
                                    sub.next();
                                    sub.complete();
                                }
                            }, 200);
                        });
                    }
                    break;
            }
            // Emit when share window is opened
            this.opened.emit(this.shareButtonName);
        }
        return EMPTY;
    }
    _serializeParams(params) {
        return Object.entries(this.shareButton.params)
            .map(([key, value]) => {
            // Check if share button param has a map function
            const paramFunc = this.shareButton.paramsFunc ? this.shareButton.paramsFunc[key] : null;
            if (params[key] || paramFunc) {
                const paramValue = paramFunc ? paramFunc(params) : params[key];
                return `${value}=${encodeURIComponent(paramValue)}`;
            }
            return '';
        })
            .filter(urlParam => urlParam !== '')
            .join('&');
    }
}
ShareDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: ShareDirective, deps: [{ token: i0.ElementRef }, { token: i1.Meta }, { token: i2.Platform }, { token: i3.Clipboard }, { token: i4.ShareService }, { token: i0.ChangeDetectorRef }, { token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Directive });
ShareDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "15.2.4", type: ShareDirective, selector: "[shareButton]", inputs: { shareButtonName: ["shareButton", "shareButtonName"], autoSetMeta: "autoSetMeta", url: "url", title: "title", description: "description", image: "image", tags: "tags" }, outputs: { opened: "opened", closed: "closed" }, host: { listeners: { "click": "share()" } }, exportAs: ["shareButton"], usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: ShareDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[shareButton]',
                    exportAs: 'shareButton'
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i1.Meta }, { type: i2.Platform }, { type: i3.Clipboard }, { type: i4.ShareService }, { type: i0.ChangeDetectorRef }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; }, propDecorators: { shareButtonName: [{
                type: Input,
                args: ['shareButton']
            }], autoSetMeta: [{
                type: Input
            }], url: [{
                type: Input
            }], title: [{
                type: Input
            }], description: [{
                type: Input
            }], image: [{
                type: Input
            }], tags: [{
                type: Input
            }], opened: [{
                type: Output
            }], closed: [{
                type: Output
            }], share: [{
                type: HostListener,
                args: ['click']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcmUtYnV0dG9uLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1zaGFyZWJ1dHRvbnMvc3JjL2xpYi9zaGFyZS1idXR0b24uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBQ1osTUFBTSxFQU1OLFlBQVksRUFHYixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFJM0MsT0FBTyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQzlELE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHaEQsT0FBTyxFQUFxRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqSCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sU0FBUyxDQUFDOzs7Ozs7QUFPdEMsTUFBTSxPQUFPLGNBQWM7SUF3RHpCLFlBQVksR0FBZSxFQUNQLEtBQVcsRUFDWCxTQUFtQixFQUNuQixVQUFxQixFQUNyQixNQUFvQixFQUNwQixHQUFzQixFQUNKLFNBQWM7UUFMaEMsVUFBSyxHQUFMLEtBQUssQ0FBTTtRQUNYLGNBQVMsR0FBVCxTQUFTLENBQVU7UUFDbkIsZUFBVSxHQUFWLFVBQVUsQ0FBVztRQUNyQixXQUFNLEdBQU4sTUFBTSxDQUFjO1FBQ3BCLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBQ0osY0FBUyxHQUFULFNBQVMsQ0FBSztRQW5EcEQsaURBQWlEO1FBQ2hDLGVBQVUsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBRWxELDREQUE0RDtRQUMzQyxhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQXlCLENBQUM7UUFpQmpFLHFFQUFxRTtRQUM1RCxnQkFBVyxHQUFZ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RSxhQUFhO2lCQUN4Qjs7MEJBK0RjLE1BQU07MkJBQUMsUUFBUTs0Q0FoQ04sZUFBZTtzQkFBcEMsS0FBSzt1QkFBQyxhQUFhO2dCQUdYLFdBQVc7c0JBQW5CLEtBQUs7Z0JBR0csR0FBRztzQkFBWCxLQUFLO2dCQUdHLEtBQUs7c0JBQWIsS0FBSztnQkFHRyxXQUFXO3NCQUFuQixLQUFLO2dCQUdHLEtBQUs7c0JBQWIsS0FBSztnQkFHRyxJQUFJO3NCQUFaLEtBQUs7Z0JBR0ksTUFBTTtzQkFBZixNQUFNO2dCQUdHLE1BQU07c0JBQWYsTUFBTTtnQkFnQlAsS0FBSztzQkFESixZQUFZO3VCQUFDLE9BQU8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIERpcmVjdGl2ZSxcclxuICBJbnB1dCxcclxuICBPdXRwdXQsXHJcbiAgSG9zdExpc3RlbmVyLFxyXG4gIEluamVjdCxcclxuICBPbkluaXQsXHJcbiAgT25DaGFuZ2VzLFxyXG4gIE9uRGVzdHJveSxcclxuICBTaW1wbGVDaGFuZ2VzLFxyXG4gIFNpbXBsZUNoYW5nZSxcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgRWxlbWVudFJlZixcclxuICBDaGFuZ2VEZXRlY3RvclJlZlxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcbmltcG9ydCB7IE1ldGEgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcclxuaW1wb3J0IHsgUGxhdGZvcm0gfSBmcm9tICdAYW5ndWxhci9jZGsvcGxhdGZvcm0nO1xyXG5pbXBvcnQgeyBDbGlwYm9hcmQgfSBmcm9tICdAYW5ndWxhci9jZGsvY2xpcGJvYXJkJztcclxuaW1wb3J0IHsgRU1QVFksIE9ic2VydmFibGUsIFN1YmplY3QsIFN1YnNjcmliZXIgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBTaGFyZVNlcnZpY2UgfSBmcm9tICcuL3NoYXJlLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBJU2hhcmVCdXR0b24sIFNoYXJlRGlyZWN0aXZlVXBkYXRlciwgU2hhcmVQYXJhbXMsIFNoYXJlUGFyYW1zRnVuYywgU2hhcmVyTWV0aG9kIH0gZnJvbSAnLi9zaGFyZS5tb2RlbHMnO1xyXG5pbXBvcnQgeyBnZXRWYWxpZFVybCB9IGZyb20gJy4vdXRpbHMnO1xyXG5pbXBvcnQgeyBzaGFyZUJ1dHRvbk5hbWUgfSBmcm9tICcuL3NoYXJlLmRlZmF1bHRzJztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW3NoYXJlQnV0dG9uXScsXHJcbiAgZXhwb3J0QXM6ICdzaGFyZUJ1dHRvbidcclxufSlcclxuZXhwb3J0IGNsYXNzIFNoYXJlRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XHJcblxyXG4gIC8qKiBWYXJpYWJsZSB1c2VkIHRvIGNoZWNrIGZvciB0aGUgZmluYWwgc2hhcmVyIHVybCAoRm9yIHRlc3Rpbmcgb25seSkgKi9cclxuICBwcml2YXRlIF9maW5hbFVybDogc3RyaW5nO1xyXG5cclxuICAvKiogU2hhcmUgZGlyZWN0aXZlIGVsZW1lbnQgcmVmICovXHJcbiAgcHJpdmF0ZSByZWFkb25seSBfZWw6IEhUTUxCdXR0b25FbGVtZW50O1xyXG5cclxuICAvKiogQSByZWYgdG8gYnV0dG9uIGNsYXNzIC0gdXNlZCB0byByZW1vdmUgcHJldmlvdXMgY2xhc3Mgd2hlbiB0aGUgYnV0dG9uIHR5cGUgaXMgY2hhbmdlZCAqL1xyXG4gIHByaXZhdGUgX2J1dHRvbkNsYXNzOiBzdHJpbmc7XHJcblxyXG4gIC8qKiBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIGJ1dHRvbiBpcyBkZXN0cm95ZWQgKi9cclxuICBwcml2YXRlIHJlYWRvbmx5IF9kZXN0cm95ZWQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xyXG5cclxuICAvKiogU3RyZWFtIHRoYXQgZW1pdCB3aGVuIHNoYXJlIGJ1dHRvbiBuZWVkIHRvIGJlIHVwZGF0ZWQgKi9cclxuICBwcml2YXRlIHJlYWRvbmx5IF91cGRhdGVyID0gbmV3IFN1YmplY3Q8U2hhcmVEaXJlY3RpdmVVcGRhdGVyPigpO1xyXG5cclxuICAvKiogU2hhcmUgYnV0dG9uIHByb3BlcnRpZXMgKi9cclxuICBzaGFyZUJ1dHRvbjogSVNoYXJlQnV0dG9uO1xyXG5cclxuICAvKiogU2hhcmUgYnV0dG9uIGNvbG9yICovXHJcbiAgY29sb3I6IHN0cmluZztcclxuXHJcbiAgLyoqIFNoYXJlIGJ1dHRvbiB0ZXh0ICovXHJcbiAgdGV4dDogc3RyaW5nO1xyXG5cclxuICAvKiogU2hhcmUgYnV0dG9uIGljb24gKi9cclxuICBpY29uOiBzdHJpbmcgfCBzdHJpbmdbXTtcclxuXHJcbiAgLyoqIFNoYXJlIGJ1dHRvbiB0eXBlICovXHJcbiAgQElucHV0KCdzaGFyZUJ1dHRvbicpIHNoYXJlQnV0dG9uTmFtZTogc2hhcmVCdXR0b25OYW1lO1xyXG5cclxuICAvKiogU2V0IG1ldGEgdGFncyBmcm9tIGRvY3VtZW50IGhlYWQsIHVzZWZ1bCB3aGVuIFNFTyBpcyBzdXBwb3J0ZWQgKi9cclxuICBASW5wdXQoKSBhdXRvU2V0TWV0YTogYm9vbGVhbiA9IHRoaXMuX3NoYXJlLmNvbmZpZy5hdXRvU2V0TWV0YTtcclxuXHJcbiAgLyoqIFNoYXJpbmcgbGluayAqL1xyXG4gIEBJbnB1dCgpIHVybDogc3RyaW5nID0gdGhpcy5fc2hhcmUuY29uZmlnLnVybDtcclxuXHJcbiAgLyoqIFNldHMgdGhlIHRpdGxlIHBhcmFtZXRlciAqL1xyXG4gIEBJbnB1dCgpIHRpdGxlOiBzdHJpbmcgPSB0aGlzLl9zaGFyZS5jb25maWcudGl0bGU7XHJcblxyXG4gIC8qKiBTZXRzIHRoZSBkZXNjcmlwdGlvbiBwYXJhbWV0ZXIgKi9cclxuICBASW5wdXQoKSBkZXNjcmlwdGlvbjogc3RyaW5nID0gdGhpcy5fc2hhcmUuY29uZmlnLmRlc2NyaXB0aW9uO1xyXG5cclxuICAvKiogU2V0cyB0aGUgaW1hZ2UgcGFyYW1ldGVyIGZvciBzaGFyaW5nIG9uIFBpbnRlcmVzdCAqL1xyXG4gIEBJbnB1dCgpIGltYWdlOiBzdHJpbmcgPSB0aGlzLl9zaGFyZS5jb25maWcuaW1hZ2U7XHJcblxyXG4gIC8qKiBTZXRzIHRoZSB0YWdzIHBhcmFtZXRlciBmb3Igc2hhcmluZyBvbiBUd2l0dGVyIGFuZCBUdW1ibHIgKi9cclxuICBASW5wdXQoKSB0YWdzOiBzdHJpbmcgPSB0aGlzLl9zaGFyZS5jb25maWcudGFncztcclxuXHJcbiAgLyoqIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gc2hhcmUgZGlhbG9nIGlzIG9wZW5lZCAqL1xyXG4gIEBPdXRwdXQoKSBvcGVuZWQgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcclxuXHJcbiAgLyoqIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gc2hhcmUgZGlhbG9nIGlzIGNsb3NlZCAqL1xyXG4gIEBPdXRwdXQoKSBjbG9zZWQgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcclxuXHJcbiAgY29uc3RydWN0b3IoX2VsOiBFbGVtZW50UmVmLFxyXG4gICAgICAgICAgICAgIHByaXZhdGUgX21ldGE6IE1ldGEsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfcGxhdGZvcm06IFBsYXRmb3JtLFxyXG4gICAgICAgICAgICAgIHByaXZhdGUgX2NsaXBib2FyZDogQ2xpcGJvYXJkLFxyXG4gICAgICAgICAgICAgIHByaXZhdGUgX3NoYXJlOiBTaGFyZVNlcnZpY2UsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfY2Q6IENoYW5nZURldGVjdG9yUmVmLFxyXG4gICAgICAgICAgICAgIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgX2RvY3VtZW50OiBhbnkpIHtcclxuICAgIHRoaXMuX2VsID0gX2VsLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTaGFyZSB0aGUgbGlua1xyXG4gICAqL1xyXG4gIEBIb3N0TGlzdGVuZXIoJ2NsaWNrJylcclxuICBzaGFyZSgpIHtcclxuICAgIC8vIEF2b2lkIFNTUiBlcnJvclxyXG4gICAgaWYgKHRoaXMuX3BsYXRmb3JtLmlzQnJvd3NlciAmJiB0aGlzLnNoYXJlQnV0dG9uKSB7XHJcbiAgICAgIC8vIFByZXBhcmUgc2hhcmVyIHVybCBwYXJhbXNcclxuICAgICAgY29uc3QgcGFyYW1zOiBTaGFyZVBhcmFtcyA9IHRoaXMuYXV0b1NldE1ldGEgPyB0aGlzLmdldFBhcmFtc0Zyb21NZXRhVGFncygpIDogdGhpcy5nZXRQYXJhbXNGcm9tSW5wdXRzKCk7XHJcblxyXG4gICAgICAvLyBQcmVwYXJlIHNoYXJlIGJ1dHRvbiBjbGlja1xyXG4gICAgICBjb25zdCBjbGljayA9IHRoaXMuc2hhcmVCdXR0b24uc2hhcmUgPyB0aGlzLm9wZW4ocGFyYW1zKSA6IHRoaXMuc2hhcmVCdXR0b24uZnVuYyh7XHJcbiAgICAgICAgcGFyYW1zLFxyXG4gICAgICAgIGRhdGE6IHRoaXMuc2hhcmVCdXR0b24uZGF0YSxcclxuICAgICAgICBjbGlwYm9hcmQ6IHRoaXMuX2NsaXBib2FyZCxcclxuICAgICAgICB1cGRhdGVyOiB0aGlzLl91cGRhdGVyXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY2xpY2sucGlwZSh0YWtlVW50aWwodGhpcy5fZGVzdHJveWVkKSkuc3Vic2NyaWJlKCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zb2xlLndhcm4oYCR7IHRoaXMudGV4dCB9IGJ1dHRvbiBpcyBub3QgY29tcGF0aWJsZSBvbiB0aGlzIFBsYXRmb3JtYCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIC8vIFRoaXMgc3RyZWFtIGlzIG1haW5seSB1c2VkIHRvIHVwZGF0ZSB0aGUgY29weSBidXR0b24gdGV4dCBhbmQgaWNvbiB3aGVuIGl0IGlzIGJlaW5nIGNsaWNrZWRcclxuICAgIHRoaXMuX3VwZGF0ZXIucGlwZShcclxuICAgICAgdGFwKChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgICB0aGlzLmljb24gPSBkYXRhLmljb247XHJcbiAgICAgICAgdGhpcy50ZXh0ID0gZGF0YS50ZXh0O1xyXG4gICAgICAgIHRoaXMuX2VsLnN0eWxlLnBvaW50ZXJFdmVudHMgPSBkYXRhLmRpc2FibGVkID8gJ25vbmUnIDogJ2F1dG8nO1xyXG4gICAgICAgIHRoaXMuX2NkLm1hcmtGb3JDaGVjaygpO1xyXG4gICAgICB9KSxcclxuICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3llZClcclxuICAgICkuc3Vic2NyaWJlKCk7XHJcbiAgfVxyXG5cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XHJcbiAgICAvLyBBdm9pZCBTU1IgZXJyb3JcclxuICAgIGlmICh0aGlzLl9wbGF0Zm9ybS5pc0Jyb3dzZXIpIHtcclxuXHJcbiAgICAgIC8vIENyZWF0ZSBzaGFyZSBidXR0b25cclxuICAgICAgaWYgKHRoaXMuX3NoYXJlQnV0dG9uQ2hhbmdlZChjaGFuZ2VzLnNoYXJlQnV0dG9uTmFtZSkpIHtcclxuICAgICAgICB0aGlzLl9jcmVhdGVTaGFyZUJ1dHRvbigpO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIFByZXBhcmUgc2hhcmUgdXJsXHJcbiAgICAgIGlmICh0aGlzLl91cmxDaGFuZ2VkKGNoYW5nZXMudXJsKSkge1xyXG4gICAgICAgIHRoaXMudXJsID0gZ2V0VmFsaWRVcmwoXHJcbiAgICAgICAgICB0aGlzLmF1dG9TZXRNZXRhXHJcbiAgICAgICAgICAgID8gdGhpcy51cmwgfHwgdGhpcy5fZ2V0TWV0YVRhZ0NvbnRlbnQoJ29nOnVybCcpXHJcbiAgICAgICAgICAgIDogdGhpcy51cmwsXHJcbiAgICAgICAgICB0aGlzLl9kb2N1bWVudC5kZWZhdWx0Vmlldy5sb2NhdGlvbi5ocmVmXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICB0aGlzLl9kZXN0cm95ZWQubmV4dCgpO1xyXG4gICAgdGhpcy5fZGVzdHJveWVkLmNvbXBsZXRlKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9jcmVhdGVTaGFyZUJ1dHRvbigpIHtcclxuICAgIGNvbnN0IGJ1dHRvbjogSVNoYXJlQnV0dG9uID0gdGhpcy5fc2hhcmUuY29uZmlnLnByb3BbdGhpcy5zaGFyZUJ1dHRvbk5hbWVdO1xyXG4gICAgaWYgKGJ1dHRvbikge1xyXG4gICAgICAvLyBTZXQgc2hhcmUgYnV0dG9uIHByb3BlcnRpZXNcclxuICAgICAgdGhpcy5zaGFyZUJ1dHRvbiA9IGJ1dHRvbjtcclxuXHJcbiAgICAgIC8vIFJlbW92ZSBwcmV2aW91cyBidXR0b24gY2xhc3NcclxuICAgICAgdGhpcy5fZWwuY2xhc3NMaXN0LnJlbW92ZShgc2ItJHsgdGhpcy5fYnV0dG9uQ2xhc3MgfWApO1xyXG5cclxuICAgICAgLy8gQWRkIG5ldyBidXR0b24gY2xhc3NcclxuICAgICAgdGhpcy5fZWwuY2xhc3NMaXN0LmFkZChgc2ItJHsgdGhpcy5zaGFyZUJ1dHRvbk5hbWUgfWApO1xyXG5cclxuICAgICAgLy8gU2V0IGJ1dHRvbiBjc3MgY29sb3IgdmFyaWFibGVcclxuICAgICAgdGhpcy5fZWwuc3R5bGUuc2V0UHJvcGVydHkoJy0tYnV0dG9uLWNvbG9yJywgdGhpcy5zaGFyZUJ1dHRvbi5jb2xvcik7XHJcblxyXG4gICAgICAvLyBLZWVwIGEgY29weSBvZiB0aGUgY2xhc3MgZm9yIGZ1dHVyZSByZXBsYWNlbWVudFxyXG4gICAgICB0aGlzLl9idXR0b25DbGFzcyA9IHRoaXMuc2hhcmVCdXR0b25OYW1lO1xyXG5cclxuICAgICAgdGhpcy5jb2xvciA9IHRoaXMuc2hhcmVCdXR0b24uY29sb3I7XHJcbiAgICAgIHRoaXMudGV4dCA9IHRoaXMuc2hhcmVCdXR0b24udGV4dDtcclxuICAgICAgdGhpcy5pY29uID0gdGhpcy5zaGFyZUJ1dHRvbi5pY29uO1xyXG5cclxuICAgICAgLy8gU2V0IGFyaWEtbGFiZWwgYXR0cmlidXRlXHJcbiAgICAgIHRoaXMuX2VsLnNldEF0dHJpYnV0ZSgnYXJpYS1sYWJlbCcsIGJ1dHRvbi5hcmlhTGFiZWwpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc29sZS5lcnJvcihgW1NoYXJlQnV0dG9uc106IFRoZSBzaGFyZSBidXR0b24gJyR7IHRoaXMuc2hhcmVCdXR0b25OYW1lIH0nIGRvZXMgbm90IGV4aXN0IWApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IG1ldGEgdGFnIGNvbnRlbnRcclxuICAgKi9cclxuICBwcml2YXRlIF9nZXRNZXRhVGFnQ29udGVudChrZXk6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBjb25zdCBtZXRhVXNpbmdQcm9wZXJ0eTogSFRNTE1ldGFFbGVtZW50ID0gdGhpcy5fbWV0YS5nZXRUYWcoYHByb3BlcnR5PVwiJHsga2V5IH1cImApO1xyXG4gICAgaWYgKG1ldGFVc2luZ1Byb3BlcnR5KSB7XHJcbiAgICAgIHJldHVybiBtZXRhVXNpbmdQcm9wZXJ0eS5nZXRBdHRyaWJ1dGUoJ2NvbnRlbnQnKTtcclxuICAgIH1cclxuICAgIGNvbnN0IG1ldGFVc2luZ05hbWU6IEhUTUxNZXRhRWxlbWVudCA9IHRoaXMuX21ldGEuZ2V0VGFnKGBuYW1lPVwiJHsga2V5IH1cImApO1xyXG4gICAgaWYgKG1ldGFVc2luZ05hbWUpIHtcclxuICAgICAgcmV0dXJuIG1ldGFVc2luZ05hbWUuZ2V0QXR0cmlidXRlKCdjb250ZW50Jyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9zaGFyZUJ1dHRvbkNoYW5nZWQoY2hhbmdlOiBTaW1wbGVDaGFuZ2UpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBjaGFuZ2UgJiYgKGNoYW5nZS5maXJzdENoYW5nZSB8fCBjaGFuZ2UucHJldmlvdXNWYWx1ZSAhPT0gY2hhbmdlLmN1cnJlbnRWYWx1ZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF91cmxDaGFuZ2VkKGNoYW5nZTogU2ltcGxlQ2hhbmdlKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gIXRoaXMudXJsIHx8IChjaGFuZ2UgJiYgY2hhbmdlLnByZXZpb3VzVmFsdWUgIT09IGNoYW5nZS5jdXJyZW50VmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IHNoYXJlIHBhcmFtcyBmcm9tIG1ldGEgdGFncyBmaXJzdCBhbmQgZmFsbGJhY2sgdG8gdXNlciBpbnB1dHNcclxuICAgKi9cclxuICBwcml2YXRlIGdldFBhcmFtc0Zyb21NZXRhVGFncygpOiBTaGFyZVBhcmFtcyB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB1cmw6IHRoaXMudXJsLFxyXG4gICAgICB0aXRsZTogdGhpcy50aXRsZSB8fCB0aGlzLl9nZXRNZXRhVGFnQ29udGVudCgnb2c6dGl0bGUnKSxcclxuICAgICAgZGVzY3JpcHRpb246IHRoaXMuZGVzY3JpcHRpb24gfHwgdGhpcy5fZ2V0TWV0YVRhZ0NvbnRlbnQoJ29nOmRlc2NyaXB0aW9uJyksXHJcbiAgICAgIGltYWdlOiB0aGlzLmltYWdlIHx8IHRoaXMuX2dldE1ldGFUYWdDb250ZW50KCdvZzppbWFnZScpLFxyXG4gICAgICB2aWE6IHRoaXMuX3NoYXJlLmNvbmZpZy50d2l0dGVyQWNjb3VudCxcclxuICAgICAgdGFnczogdGhpcy50YWdzXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IHNoYXJlIHBhcmFtcyBmcm9tIHVzZXIgaW5wdXRzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRQYXJhbXNGcm9tSW5wdXRzKCk6IFNoYXJlUGFyYW1zIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHVybDogdGhpcy51cmwsXHJcbiAgICAgIHRpdGxlOiB0aGlzLnRpdGxlLFxyXG4gICAgICBkZXNjcmlwdGlvbjogdGhpcy5kZXNjcmlwdGlvbixcclxuICAgICAgaW1hZ2U6IHRoaXMuaW1hZ2UsXHJcbiAgICAgIHRhZ3M6IHRoaXMudGFncyxcclxuICAgICAgdmlhOiB0aGlzLl9zaGFyZS5jb25maWcudHdpdHRlckFjY291bnQsXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvcGVuKHBhcmFtczogU2hhcmVQYXJhbXMpOiBPYnNlcnZhYmxlPHZvaWQ+IHtcclxuICAgIC8vIFNldCBzaGFyZXIgbGluayBiYXNlZCBvbiB1c2VyJ3MgZGV2aWNlXHJcbiAgICBsZXQgc2hhcmVyTGluazogc3RyaW5nO1xyXG4gICAgaWYgKHRoaXMuX3BsYXRmb3JtLklPUyAmJiB0aGlzLnNoYXJlQnV0dG9uLnNoYXJlLmlvcykge1xyXG4gICAgICBzaGFyZXJMaW5rID0gdGhpcy5zaGFyZUJ1dHRvbi5zaGFyZS5pb3M7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuX3BsYXRmb3JtLkFORFJPSUQgJiYgdGhpcy5zaGFyZUJ1dHRvbi5zaGFyZS5hbmRyb2lkKSB7XHJcbiAgICAgIHNoYXJlckxpbmsgPSB0aGlzLnNoYXJlQnV0dG9uLnNoYXJlLmFuZHJvaWQ7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBzaGFyZXJMaW5rID0gdGhpcy5zaGFyZUJ1dHRvbi5zaGFyZS5kZXNrdG9wO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChzaGFyZXJMaW5rKSB7XHJcbiAgICAgIC8vIFNldCBzaGFyZXIgbGluayBwYXJhbXNcclxuICAgICAgdGhpcy5fZmluYWxVcmwgPSBzaGFyZXJMaW5rICsgdGhpcy5fc2VyaWFsaXplUGFyYW1zKHBhcmFtcyk7XHJcblxyXG4gICAgICAvLyBMb2cgdGhlIHNoYXJlciBsaW5rIGluIGRlYnVnIG1vZGVcclxuICAgICAgaWYgKHRoaXMuX3NoYXJlLmNvbmZpZy5kZWJ1Zykge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdbREVCVUcgU0hBUkUgQlVUVE9OXTogJywgdGhpcy5fZmluYWxVcmwpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBPcGVuIHRoZSBzaGFyZSB3aW5kb3dcclxuICAgICAgLy8gVGhlcmUgYXJlIHR3byBtZXRob2RzIGF2YWlsYWJsZSBmb3Igb3BlbmluZyB0aGUgc2hhcmUgd2luZG93OlxyXG4gICAgICAvLyAxLiBVc2luZyBhIHJlYWwgYW5jaG9yXHJcbiAgICAgIC8vIDIuIFVzaW5nIHdpbmRvdy5vcGVuXHJcbiAgICAgIGNvbnN0IHNoYXJlck1ldGhvZCA9IHRoaXMuc2hhcmVCdXR0b24ubWV0aG9kIHx8IHRoaXMuX3NoYXJlLmNvbmZpZy5zaGFyZXJNZXRob2Q7XHJcbiAgICAgIGNvbnN0IHNoYXJlclRhcmdldCA9IHRoaXMuc2hhcmVCdXR0b24udGFyZ2V0IHx8IHRoaXMuX3NoYXJlLmNvbmZpZy5zaGFyZXJUYXJnZXQ7XHJcblxyXG4gICAgICBzd2l0Y2ggKHNoYXJlck1ldGhvZCkge1xyXG5cclxuICAgICAgICBjYXNlIFNoYXJlck1ldGhvZC5BbmNob3I6XHJcbiAgICAgICAgICBjb25zdCBsaW5rRWxlbWVudDogSFRNTExpbmtFbGVtZW50ID0gdGhpcy5fZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xyXG4gICAgICAgICAgLy8gTWFrZSBpdCBvcGVuIGluIGEgbmV3IHRhYi93aW5kb3cgKGRlcGVuZHMgb24gdXNlcidzIGJyb3dzZXIgY29uZmlndXJhdGlvbilcclxuICAgICAgICAgIGxpbmtFbGVtZW50LnNldEF0dHJpYnV0ZSgndGFyZ2V0Jywgc2hhcmVyVGFyZ2V0KTtcclxuXHJcbiAgICAgICAgICAvLyBQcmV2ZW50IHNlY3VyaXR5IHZ1bG5lcmFiaWxpdHkgaHR0cHM6Ly9tZWRpdW0uY29tL0BqaXRiaXQvdGFyZ2V0LWJsYW5rLXRoZS1tb3N0LXVuZGVyZXN0aW1hdGVkLXZ1bG5lcmFiaWxpdHktZXZlci05NmUzMjgzMDFmNGNcclxuICAgICAgICAgIGxpbmtFbGVtZW50LnNldEF0dHJpYnV0ZSgncmVsJywgJ25vb3BlbmVyIG5vcmVmZXJyZXInKTtcclxuICAgICAgICAgIGxpbmtFbGVtZW50LmhyZWYgPSB0aGlzLl9maW5hbFVybDtcclxuICAgICAgICAgIGxpbmtFbGVtZW50LmNsaWNrKCk7XHJcbiAgICAgICAgICBsaW5rRWxlbWVudC5yZW1vdmUoKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICBjYXNlIFNoYXJlck1ldGhvZC5XaW5kb3c6XHJcbiAgICAgICAgICAvLyBPcGVuIGxpbmsgdXNpbmcgV2luZG93IG9iamVjdFxyXG4gICAgICAgICAgY29uc3Qgb3BlbldpbmRvdyA9IHRoaXMuX3NoYXJlLmNvbmZpZy53aW5kb3dPYmpbdGhpcy5fc2hhcmUuY29uZmlnLndpbmRvd0Z1bmNOYW1lXTtcclxuICAgICAgICAgIGNvbnN0IHBvcFVwV2luZG93ID0gb3BlbldpbmRvdyh0aGlzLl9maW5hbFVybCwgc2hhcmVyVGFyZ2V0LCB0aGlzLl9zaGFyZS53aW5kb3dTaXplKTtcclxuXHJcbiAgICAgICAgICAvLyBQcmV2ZW50IHNlY3VyaXR5IHZ1bG5lcmFiaWxpdHkgaHR0cHM6Ly9tZWRpdW0uY29tL0BqaXRiaXQvdGFyZ2V0LWJsYW5rLXRoZS1tb3N0LXVuZGVyZXN0aW1hdGVkLXZ1bG5lcmFiaWxpdHktZXZlci05NmUzMjgzMDFmNGNcclxuICAgICAgICAgIHRoaXMuX3NoYXJlLmNvbmZpZy53aW5kb3dPYmoub3BlbmVyID0gbnVsbDtcclxuXHJcbiAgICAgICAgICAvLyBSZXNvbHZlIHdoZW4gc2hhcmUgZGlhbG9nIGlzIGNsb3NlZFxyXG4gICAgICAgICAgaWYgKHBvcFVwV2luZG93KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZTx2b2lkPigoc3ViOiBTdWJzY3JpYmVyPHZvaWQ+KSA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc3QgcG9sbFRpbWVyID0gdGhpcy5fZG9jdW1lbnQuZGVmYXVsdFZpZXcuc2V0SW50ZXJ2YWwoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHBvcFVwV2luZG93LmNsb3NlZCkge1xyXG4gICAgICAgICAgICAgICAgICB0aGlzLl9kb2N1bWVudC5kZWZhdWx0Vmlldy5jbGVhckludGVydmFsKHBvbGxUaW1lcik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAvLyBFbWl0IHdoZW4gc2hhcmUgd2luZG93cyBpcyBjbG9zZWRcclxuICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZWQuZW1pdCh0aGlzLnNoYXJlQnV0dG9uTmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgIHN1Yi5uZXh0KCk7XHJcbiAgICAgICAgICAgICAgICAgIHN1Yi5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH0sIDIwMCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIEVtaXQgd2hlbiBzaGFyZSB3aW5kb3cgaXMgb3BlbmVkXHJcbiAgICAgIHRoaXMub3BlbmVkLmVtaXQodGhpcy5zaGFyZUJ1dHRvbk5hbWUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIEVNUFRZO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfc2VyaWFsaXplUGFyYW1zKHBhcmFtczogU2hhcmVQYXJhbXMpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKHRoaXMuc2hhcmVCdXR0b24ucGFyYW1zKVxyXG4gICAgLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB7XHJcbiAgICAgIC8vIENoZWNrIGlmIHNoYXJlIGJ1dHRvbiBwYXJhbSBoYXMgYSBtYXAgZnVuY3Rpb25cclxuICAgICAgY29uc3QgcGFyYW1GdW5jOiBTaGFyZVBhcmFtc0Z1bmMgPSB0aGlzLnNoYXJlQnV0dG9uLnBhcmFtc0Z1bmMgPyB0aGlzLnNoYXJlQnV0dG9uLnBhcmFtc0Z1bmNba2V5XSA6IG51bGw7XHJcblxyXG4gICAgICBpZiAocGFyYW1zW2tleV0gfHwgcGFyYW1GdW5jKSB7XHJcbiAgICAgICAgY29uc3QgcGFyYW1WYWx1ZSA9IHBhcmFtRnVuYyA/IHBhcmFtRnVuYyhwYXJhbXMpIDogcGFyYW1zW2tleV07XHJcbiAgICAgICAgcmV0dXJuIGAkeyB2YWx1ZSB9PSR7IGVuY29kZVVSSUNvbXBvbmVudChwYXJhbVZhbHVlKSB9YDtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gJyc7XHJcbiAgICB9KVxyXG4gICAgLmZpbHRlcih1cmxQYXJhbSA9PiB1cmxQYXJhbSAhPT0gJycpXHJcbiAgICAuam9pbignJicpO1xyXG4gIH1cclxufVxyXG4iXX0=